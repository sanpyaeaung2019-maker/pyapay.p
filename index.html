
<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Pya Pay | ခရီးသည်</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- React & Supabase Global Scripts -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; overflow: hidden; margin: 0; }
        .map-container { height: 100vh; width: 100%; position: absolute; z-index: 0; background: #e5e7eb; }
        .glass-panel { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(12px); border-top: 1px solid rgba(0,0,0,0.05); border-radius: 32px 32px 0 0; }
        .btn-primary { background-color: #45C9FF; color: white; transition: all 0.2s; border-radius: 20px; font-weight: 800; box-shadow: 0 8px 20px -6px rgba(69, 201, 255, 0.6); }
        .btn-primary:active { transform: scale(0.96); opacity: 0.9; }
        .leaflet-control-attribution { display: none !important; }
        
        .user-location-marker {
            width: 24px; height: 24px; background: #45C9FF; border: 4px solid white; border-radius: 50%;
            box-shadow: 0 0 20px rgba(69, 201, 255, 0.8); position: relative;
        }
        .user-location-marker::after {
            content: ''; position: absolute; width: 48px; height: 48px; background: #45C9FF;
            border-radius: 50%; top: -16px; left: -16px; animation: pulse 2s infinite; opacity: 0.3;
        }
        @keyframes pulse { 0% { transform: scale(0.5); opacity: 0.6; } 100% { transform: scale(1.8); opacity: 0; } }
    </style>
</head>
<body>
    <div id="passenger-root"></div>

    <script>
        const { useState, useEffect, useRef } = React;
        const supabaseUrl = 'https://pgjeyazxdcdibtlgntcv.supabase.co';
        const supabaseKey = 'sb_publishable_htbAIYFf4liqDj1if_LEBw_B15Y0Bp9';
        
        // Supabase Client Initialization with fallback
        let supabase = null;
        try {
            if (window.supabase) {
                supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
            } else {
                console.error("Supabase library not loaded yet.");
            }
        } catch (e) {
            console.error("Supabase initialization error:", e);
        }

        const PassengerApp = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('auth'); 
            const [loading, setLoading] = useState(false);
            const [currentPos, setCurrentPos] = useState(null);
            const [locationError, setLocationError] = useState(null);
            const [isSecure, setIsSecure] = useState(true);
            const [pickup, setPickup] = useState({ address: 'တည်နေရာ ရှာဖွေနေဆဲ...', lat: 0, lng: 0 });
            const [dropoff, setDropoff] = useState("");
            
            const mapContainer = useRef(null);
            const leafletMap = useRef(null);
            const userMarker = useRef(null);

            useEffect(() => {
                // Check if running on secure context (required for GPS)
                if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                    setIsSecure(false);
                }

                if (supabase) {
                    supabase.auth.getSession().then(({ data: { session } }) => {
                        if (session) { setUser(session.user); setView('home'); }
                    });
                }
            }, []);

            useEffect(() => {
                if (view === 'home') {
                    if (!leafletMap.current && mapContainer.current) {
                        const yangon = [16.8661, 96.1951];
                        leafletMap.current = L.map(mapContainer.current, { zoomControl: false, attributionControl: false }).setView(yangon, 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(leafletMap.current);
                    }
                    tryRequestLocation();
                }
            }, [view]);

            const tryRequestLocation = () => {
                setLocationError(null);
                if (!navigator.geolocation) {
                    alert("သင့်ဖုန်းသည် GPS စနစ်ကို အထောက်အပံ့မပေးပါ။");
                    return;
                }

                const options = { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 };

                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const newPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        setCurrentPos(newPos);
                        updateUserMarker(newPos);
                        if (leafletMap.current) {
                            leafletMap.current.setView([newPos.lat, newPos.lng], 18);
                        }
                        setPickup({ address: 'လက်ရှိတည်နေရာ', lat: pos.coords.latitude, lng: pos.coords.longitude });
                        
                        navigator.geolocation.watchPosition((p) => {
                            const pData = { lat: p.coords.latitude, lng: p.coords.longitude };
                            setCurrentPos(pData);
                            updateUserMarker(pData);
                        }, null, { enableHighAccuracy: true });
                    },
                    (err) => {
                        console.error("GPS Error:", err);
                        if (err.code === 1) setLocationError('denied');
                        else if (err.code === 3) setLocationError('timeout');
                        else setLocationError('unavailable');
                    },
                    options
                );
            };

            const updateUserMarker = (pos) => {
                if (!leafletMap.current) return;
                const latlng = [pos.lat, pos.lng];
                if (!userMarker.current) {
                    const icon = L.divIcon({ className: 'custom-div-icon', html: '<div class="user-location-marker"></div>', iconSize: [24, 24], iconAnchor: [12, 12] });
                    userMarker.current = L.marker(latlng, { icon }).addTo(leafletMap.current);
                } else {
                    userMarker.current.setLatLng(latlng);
                }
            };

            const recenterMap = () => {
                if (currentPos && leafletMap.current) {
                    leafletMap.current.setView([currentPos.lat, currentPos.lng], 18);
                } else {
                    tryRequestLocation();
                }
            };

            // Non-Secure Warning
            if (!isSecure) return React.createElement('div', { className: 'h-screen w-full bg-slate-900 flex flex-col items-center justify-center p-8 text-center text-white' },
                React.createElement('div', { className: 'w-20 h-20 bg-yellow-500 rounded-full flex items-center justify-center mb-6 text-slate-900' },
                    React.createElement('svg', { className: 'w-10 h-10', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                        React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '3', d: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z' })
                    )
                ),
                React.createElement('h2', { className: 'text-2xl font-black mb-4' }, 'HTTPS လိုအပ်ပါသည်'),
                React.createElement('p', { className: 'text-slate-400 mb-8' }, 'GPS အသုံးပြုနိုင်ရန်အတွက် ဤ App ကို HTTPS လိပ်စာဖြင့်သာ ဖွင့်ရပါမည်။ Github Pages (သို့) Vercel တွင် အခမဲ့တင်၍ စမ်းသပ်နိုင်ပါသည်။'),
                React.createElement('a', { href: 'https://vercel.com', className: 'btn-primary px-8 py-3' }, 'Hosting တွင်တင်မည်')
            );

            if (view === 'auth') return React.createElement(AuthScreen, { 
                onAuth: async (e, p, t) => {
                    if (!supabase) { alert("Server ချိတ်ဆက်မှု အခက်အခဲရှိနေပါသည်။"); return; }
                    setLoading(true);
                    const { data, error } = t === 'login' ? await supabase.auth.signInWithPassword({ email: e, password: p }) : await supabase.auth.signUp({ email: e, password: p });
                    if (error) alert("အီးမေးလ် သို့မဟုတ် လျှို့ဝှက်နံပါတ် မှားယွင်းနေပါသည်။");
                    else { setUser(data.user); setView('home'); }
                    setLoading(false);
                }, 
                loading 
            });

            return React.createElement('div', { className: 'h-screen w-full relative' },
                React.createElement('div', { ref: mapContainer, className: 'map-container' }),
                
                // NO GPS / ERROR OVERLAY
                (!currentPos || locationError) && React.createElement('div', { className: 'absolute inset-0 z-[2000] bg-white/95 flex flex-col items-center justify-center p-8 text-center backdrop-blur-md' },
                    React.createElement('div', { className: 'w-24 h-24 bg-red-100 text-red-500 rounded-full flex items-center justify-center mb-6' },
                        React.createElement('svg', { className: 'w-12 h-12', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                            React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '3', d: 'M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z' }),
                            React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '3', d: 'M15 11a3 3 0 11-6 0 3 3 0 016 0z' })
                        )
                    ),
                    React.createElement('h3', { className: 'text-2xl font-black text-gray-800 mb-3' }, locationError === 'denied' ? 'တည်နေရာ ခွင့်ပြုချက် ပိတ်ထားသည်' : 'GPS ရှာမတွေ့ပါ'),
                    React.createElement('p', { className: 'text-gray-500 mb-8 max-w-xs font-medium' }, 'ခရီးစဉ်ခေါ်ယူရန် သင့်ဖုန်း Setting > Apps တွင် Location ကို "Allow" ပေးရန်လိုအပ်ပါသည်။'),
                    React.createElement('button', { onClick: tryRequestLocation, className: 'btn-primary px-10 py-4 shadow-xl active:scale-95' }, 'တည်နေရာ ပြန်ရှာမည်')
                ),

                // TOP NAV
                React.createElement('div', { className: 'absolute top-10 left-4 right-4 z-[1000] flex justify-between items-center pointer-events-none' },
                    React.createElement('div', { className: 'bg-white px-4 py-3 rounded-2xl shadow-xl flex items-center gap-3 pointer-events-auto border border-gray-50' },
                        React.createElement('div', { className: 'w-9 h-9 bg-[#45C9FF] rounded-xl flex items-center justify-center font-black text-white italic text-lg shadow-sm shadow-[#45C9FF]/30' }, 'PP'),
                        React.createElement('div', { className: 'flex flex-col' },
                            React.createElement('span', { className: 'font-black text-gray-800 text-sm leading-none mb-0.5' }, 'Pya Pay'),
                            React.createElement('span', { className: 'text-[9px] font-bold text-[#45C9FF] uppercase tracking-widest' }, 'Passenger')
                        )
                    ),
                    React.createElement('button', { onClick: () => { supabase && supabase.auth.signOut(); setView('auth'); }, className: 'bg-white p-3 rounded-2xl shadow-xl text-red-500 pointer-events-auto border border-gray-50 active:scale-90 transition-all' },
                        React.createElement('svg', { className: 'w-6 h-6', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                            React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2.5', d: 'M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1' })
                        )
                    )
                ),

                // RECENTER BUTTON
                React.createElement('div', { className: 'absolute right-4 bottom-80 z-[1000] flex flex-col gap-3 pointer-events-auto' },
                    React.createElement('button', { onClick: recenterMap, className: 'bg-white p-4 rounded-full shadow-2xl active:scale-90 border border-gray-100 transition-all' },
                        React.createElement('svg', { className: 'w-7 h-7 text-[#45C9FF]', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                            React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '3', d: 'M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z' }),
                            React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '3', d: 'M15 11a3 3 0 11-6 0 3 3 0 016 0z' })
                        )
                    )
                ),

                // BOOKING CARD
                React.createElement('div', { className: 'absolute bottom-0 left-0 right-0 z-[1000]' },
                    React.createElement('div', { className: 'glass-panel p-7 shadow-2xl space-y-6 pb-12' },
                        React.createElement('h2', { className: 'text-2xl font-black text-gray-800' }, 'ဘယ်သွားမလဲ?'),
                        React.createElement('div', { className: 'space-y-3' },
                            React.createElement('div', { className: 'flex items-center gap-4 p-4.5 bg-gray-50 rounded-[22px] border border-gray-100 shadow-inner' },
                                React.createElement('div', { className: 'w-3 h-3 rounded-full bg-[#45C9FF] shadow-[0_0_10px_#45C9FF]' }),
                                React.createElement('input', { className: 'bg-transparent flex-1 outline-none text-gray-700 font-bold text-sm', value: pickup.address, readOnly: true })
                            ),
                            React.createElement('div', { className: 'flex items-center gap-4 p-4.5 bg-white rounded-[22px] border-2 border-[#45C9FF] shadow-sm' },
                                React.createElement('div', { className: 'w-3 h-3 rounded-full bg-red-500 shadow-[0_0_10px_#ef4444]' }),
                                React.createElement('input', { placeholder: 'သွားမည့်နေရာရိုက်ထည့်ပါ', className: 'bg-transparent flex-1 outline-none text-gray-800 font-black text-base', value: dropoff, onChange: e => setDropoff(e.target.value) })
                            )
                        ),
                        React.createElement('button', { className: 'btn-primary w-full py-5 text-xl' }, 'ယာဉ်ခေါ်မည် (၂၅၀၀ ကျပ်)')
                    )
                )
            );
        };

        const AuthScreen = ({ onAuth, loading }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            return React.createElement('div', { className: 'h-screen w-full bg-[#45C9FF] flex flex-col px-10 justify-center' },
                React.createElement('div', { className: 'mb-12 text-center' },
                    React.createElement('div', { className: 'w-24 h-24 bg-white rounded-[32px] flex items-center justify-center shadow-2xl mx-auto mb-6' },
                        React.createElement('span', { className: 'text-[#45C9FF] text-4xl font-black italic' }, 'PP')
                    ),
                    React.createElement('h1', { className: 'text-white text-4xl font-black tracking-tighter mb-2' }, 'Pya Pay')
                ),
                React.createElement('div', { className: 'bg-white rounded-[40px] p-9 shadow-2xl space-y-6 border border-white/50' },
                    React.createElement('h2', { className: 'text-2xl font-black text-gray-800 text-center' }, isLogin ? 'အကောင့်ဝင်ရန်' : 'အကောင့်သစ်ဖွင့်ရန်'),
                    React.createElement('div', { className: 'space-y-4' },
                        React.createElement('input', { className: 'w-full p-4.5 bg-gray-50 border border-gray-100 rounded-2xl outline-none text-base font-bold', placeholder: 'အီးမေးလ်', value: email, onChange: e => setEmail(e.target.value) }),
                        React.createElement('input', { type: 'password', className: 'w-full p-4.5 bg-gray-50 border border-gray-100 rounded-2xl outline-none text-base font-bold', placeholder: 'လျှို့ဝှက်နံပါတ်', value: password, onChange: e => setPassword(e.target.value) })
                    ),
                    React.createElement('button', { onClick: () => onAuth(email, password, isLogin ? 'login' : 'signup'), disabled: loading, className: 'btn-primary w-full py-5 text-lg' }, loading ? 'ခဏစောင့်ပါ...' : isLogin ? 'ဝင်မည်' : 'ဖွင့်မည်'),
                    React.createElement('p', { className: 'text-center text-gray-400 text-sm font-black cursor-pointer uppercase tracking-tight', onClick: () => setIsLogin(!isLogin) }, isLogin ? "အကောင့်မရှိသေးပါက? အသစ်ဖွင့်ရန်" : "အကောင့်ရှိပြီးသားလား? ပြန်ဝင်ရန်")
                )
            );
        };

        const container = document.getElementById('passenger-root');
        if (container) {
            const root = ReactDOM.createRoot(container);
            root.render(React.createElement(PassengerApp));
        }
    </script>
</body>
</html>
