
<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Pya Pay - Passenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; overflow: hidden; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .pya-blue { color: #45C9FF; }
        .bg-pya { background-color: #45C9FF; }
        
        #map { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 0; }
        
        .view-hidden { display: none !important; }
        
        /* Selection Pin - Reduced size as requested */
        .center-pin {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -100%);
            z-index: 100; pointer-events: none;
        }

        /* Sidebar styling */
        #sidebar {
            position: fixed; top: 0; left: -100%; width: 85%; max-width: 320px; height: 100%;
            background: white; z-index: 200; transition: left 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 10px 0 30px rgba(0,0,0,0.1);
        }
        #sidebar.open { left: 0; }
        #overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4);
            z-index: 190; display: none; backdrop-filter: blur(4px);
        }

        /* Manual Scroll Ads */
        .ad-scroll-container {
            display: flex; overflow-x: auto; scroll-snap-type: x mandatory;
            -ms-overflow-style: none; scrollbar-width: none;
            gap: 12px; padding: 0 24px;
        }
        .ad-scroll-container::-webkit-scrollbar { display: none; }
        .ad-card { flex: 0 0 85%; scroll-snap-align: center; }

        .service-btn { transition: all 0.2s; }
        .service-btn:active { transform: scale(0.95); }

        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 12px 24px; border-radius: 99px;
            font-weight: bold; font-size: 12px; z-index: 1000; display: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        /* Radar Pulse Animation for Searching UI */
        .radar-pulse {
            position: relative; width: 140px; height: 140px;
            background: rgba(69, 201, 255, 0.15); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }
        .radar-pulse::before, .radar-pulse::after {
            content: ''; position: absolute; border: 2px solid #45C9FF;
            border-radius: 50%; animation: pulse 2.5s linear infinite;
        }
        .radar-pulse::after { animation-delay: 1.25s; }
        @keyframes pulse {
            0% { width: 100px; height: 100px; opacity: 1; }
            100% { width: 350px; height: 350px; opacity: 0; }
        }

        .user-loc-dot {
            width: 14px; height: 14px; background: #45C9FF;
            border: 2px solid white; border-radius: 50%;
            box-shadow: 0 0 10px rgba(69, 201, 255, 0.5);
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <div id="toast" class="toast"></div>

    <!-- VIEW: SEARCHING OVERLAY (Grab Style) -->
    <div id="view-searching" class="fixed inset-0 z-[1000] bg-white view-hidden flex flex-col items-center justify-center p-8 text-center animate-fade-in">
        <div class="radar-pulse mb-16">
            <div class="bg-pya p-6 rounded-full shadow-2xl z-10 relative">
                <i id="searching-icon" data-lucide="bike" class="text-white w-14 h-14"></i>
            </div>
        </div>
        <h2 class="text-2xl font-black text-gray-800 mb-2">ယာဉ်မောင်း ရှာဖွေနေပါသည်</h2>
        <p class="text-gray-400 font-bold text-xs uppercase tracking-[0.2em] mb-12">Finding your nearest driver</p>
        
        <div class="w-full max-w-sm space-y-4">
            <div class="flex items-center justify-between p-5 bg-gray-50 rounded-[24px] border border-gray-100">
                <div class="flex items-center gap-4">
                    <div class="p-2 bg-blue-50 rounded-xl"><i data-lucide="navigation" class="text-pya w-5 h-5"></i></div>
                    <div class="text-left">
                        <p id="searching-dist" class="text-sm font-black text-gray-800">0.0 km</p>
                        <p class="text-[9px] font-black text-gray-400 uppercase tracking-tighter">Distance</p>
                    </div>
                </div>
                <div class="text-right">
                    <p id="searching-fare" class="text-lg font-black text-pya">0 Ks</p>
                    <p class="text-[9px] font-black text-gray-400 uppercase tracking-tighter">Trip Fare</p>
                </div>
            </div>
            <button onclick="cancelSearching()" class="w-full bg-red-50 text-red-500 font-black py-4 rounded-2xl text-sm uppercase tracking-widest active:scale-95 transition-all">
                ရှာဖွေမှု ရပ်တန့်မည်
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="main-content" class="flex-1 relative flex flex-col overflow-hidden">
        
        <!-- VIEW: HOME -->
        <div id="view-home" class="flex-1 flex flex-col safe-top overflow-y-auto bg-gray-50 pb-20">
            <!-- Top Bar -->
            <div class="px-6 py-4 flex items-center justify-between">
                <button onclick="toggleSidebar(true)" class="p-2 bg-white rounded-xl shadow-sm"><i data-lucide="menu" class="pya-blue"></i></button>
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-pya rounded-lg flex items-center justify-center text-white font-black italic">P</div>
                    <span class="font-black text-gray-800 tracking-tighter text-lg uppercase">Pya Pay</span>
                </div>
                <div class="w-10"></div>
            </div>

            <!-- Service Selection -->
            <div class="px-6 mt-6">
                <h2 class="text-xs font-black text-gray-400 uppercase tracking-widest mb-4">ကျွန်ုပ်တို့၏ ဝန်ဆောင်မှုများ</h2>
                <div class="grid grid-cols-3 gap-3">
                    <button onclick="selectService('OWAY')" class="service-btn bg-white p-5 rounded-[32px] shadow-sm flex flex-col items-center border border-gray-100">
                        <div class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center mb-3">
                            <i data-lucide="bike" class="text-pya w-6 h-6"></i>
                        </div>
                        <span class="text-[10px] font-black text-gray-800 uppercase">အိုးဝေ</span>
                    </button>
                    <button onclick="selectService('CAR')" class="service-btn bg-white p-5 rounded-[32px] shadow-sm flex flex-col items-center border border-gray-100">
                        <div class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center mb-3">
                            <i data-lucide="car" class="pya-blue w-6 h-6"></i>
                        </div>
                        <span class="text-[10px] font-black text-gray-800 uppercase">ကား</span>
                    </button>
                    <button onclick="showToast('Coming Soon!')" class="service-btn bg-white p-5 rounded-[32px] shadow-sm flex flex-col items-center border border-gray-100 opacity-60">
                        <div class="w-12 h-12 bg-gray-50 rounded-2xl flex items-center justify-center mb-3">
                            <i data-lucide="package" class="text-gray-300 w-6 h-6"></i>
                        </div>
                        <span class="text-[10px] font-black text-gray-400 uppercase">Delivery</span>
                    </button>
                </div>
            </div>

            <!-- Auto Ad Slider -->
            <div class="px-6 mt-8">
                <div class="relative w-full h-40 bg-pya rounded-[40px] overflow-hidden shadow-lg">
                    <div id="auto-ad-container" class="w-full h-full flex transition-transform duration-700">
                        <div class="min-w-full h-full flex items-center justify-center text-white p-8">
                            <div class="text-center">
                                <h4 class="text-2xl font-black">20% Cashback</h4>
                                <p class="text-xs font-bold opacity-80 mt-1">ပထမဆုံး အိုးဝေ ခရီးစဉ်အတွက်</p>
                            </div>
                        </div>
                        <div class="min-w-full h-full bg-blue-600 flex items-center justify-center text-white p-8">
                            <div class="text-center">
                                <h4 class="text-2xl font-black">Verified Drivers</h4>
                                <p class="text-xs font-bold opacity-80 mt-1">စိတ်ချရသော ယာဉ်မောင်းများသာ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manual Swipe Ads (Restored) -->
            <div class="mt-10">
                <div class="px-6 flex items-center justify-between mb-4">
                    <h2 class="text-xs font-black text-gray-400 uppercase tracking-widest">Promotion ကြော်ငြာများ</h2>
                    <span class="text-[9px] font-black text-pya uppercase">ဆွဲကြည့်ရန်</span>
                </div>
                <div class="ad-scroll-container">
                    <div class="ad-card">
                        <div class="bg-indigo-600 h-36 rounded-[32px] overflow-hidden shadow-lg flex items-center justify-center text-white p-8">
                           <div class="text-center">
                                <h4 class="text-2xl font-black">Daily Rewards</h4>
                                <p class="text-xs font-bold opacity-80 mt-1">နေ့စဉ် ခရီးစဉ်များအတွက် လက်ဆောင်များ</p>
                            </div>
                        </div>
                    </div>
                    <div class="ad-card">
                        <div class="bg-pink-600 h-36 rounded-[32px] overflow-hidden shadow-lg flex items-center justify-center text-white p-8">
                           <div class="text-center">
                                <h4 class="text-2xl font-black">Safe Ride</h4>
                                <p class="text-xs font-bold opacity-80 mt-1">အကာအကွယ်အပြည့်ဖြင့် ခရီးသွားပါ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Call Support -->
            <div class="px-6 mt-8">
                <button onclick="window.location.href='tel:09123456789'" class="w-full bg-white p-6 rounded-[32px] shadow-sm border border-gray-100 flex items-center justify-between active:scale-95 transition-transform">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-green-50 rounded-full flex items-center justify-center text-green-500">
                            <i data-lucide="phone-call" class="w-6 h-6"></i>
                        </div>
                        <div class="text-left">
                            <h3 class="font-black text-gray-800 text-sm">ဖုန်းဖြင့် တိုက်ရိုက်ခေါ်ဆိုရန်</h3>
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Direct Support</p>
                        </div>
                    </div>
                    <i data-lucide="chevron-right" class="text-gray-200"></i>
                </button>
            </div>
        </div>

        <!-- VIEW: MAP SELECTION (Booking Interface) -->
        <div id="view-map-select" class="flex-1 flex flex-col view-hidden bg-white relative">
            <div id="map"></div>
            
            <!-- Selection Pin - MADE SMALLER (w-8 h-8) -->
            <div id="center-pin" class="center-pin hidden">
                <div class="flex flex-col items-center">
                    <div id="pin-label" class="bg-gray-800 text-white text-[8px] font-black px-2 py-1 rounded-full mb-1 shadow-2xl uppercase tracking-tighter">တည်နေရာရွေးပါ</div>
                    <i id="main-ping-icon" data-lucide="map-pin" class="w-8 h-8 text-green-500 fill-green-500/20 stroke-[3]"></i>
                </div>
            </div>

            <!-- Back Nav to Home -->
            <button onclick="switchView('home')" class="absolute top-4 left-4 z-20 bg-white p-3 rounded-2xl shadow-xl active:scale-90 transition-transform border border-gray-100">
                <i data-lucide="arrow-left" class="pya-blue w-6 h-6"></i>
            </button>

            <!-- Bottom Panel -->
            <div id="booking-panel" class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[48px] shadow-[0_-20px_50px_rgba(0,0,0,0.1)] p-8 safe-bottom z-30 transition-all duration-300">
                <div class="w-12 h-1.5 bg-gray-100 rounded-full mx-auto mb-8"></div>
                
                <div id="location-inputs" class="space-y-4">
                    <div class="relative flex items-center gap-4 bg-gray-50 p-4 rounded-2xl border border-gray-100 focus-within:border-pya transition-all">
                        <i data-lucide="circle-dot" class="w-5 h-5 text-green-500 shrink-0"></i>
                        <input type="text" id="input-pickup" placeholder="လာကြိုရမည့် တည်နေရာ" class="flex-1 bg-transparent border-none outline-none font-bold text-gray-800 text-sm">
                        <button onclick="startMapPick('pickup')" class="text-green-500 p-1.5 hover:bg-green-50 rounded-xl transition-colors"><i data-lucide="map-pin" class="w-6 h-6"></i></button>
                    </div>
                    <div class="relative flex items-center gap-4 bg-gray-50 p-4 rounded-2xl border border-gray-100 focus-within:border-pya transition-all">
                        <i data-lucide="map-pin" class="w-5 h-5 text-red-500 shrink-0"></i>
                        <input type="text" id="input-dest" oninput="handleSearch(this.value)" placeholder="သွားလိုသည့် တည်နေရာ" class="flex-1 bg-transparent border-none outline-none font-bold text-gray-800 text-sm">
                        <button onclick="startMapPick('dest')" class="text-red-500 p-1.5 hover:bg-red-50 rounded-xl transition-colors"><i data-lucide="map-pin" class="w-6 h-6"></i></button>
                    </div>
                    <div id="search-results" class="hidden absolute left-8 right-8 top-40 bg-white rounded-[24px] shadow-2xl z-50 max-h-56 overflow-y-auto border border-gray-100 divide-y divide-gray-50"></div>
                </div>

                <!-- Stats and Final Action -->
                <div id="route-stats" class="hidden mt-8 flex flex-col gap-5">
                    <div class="flex justify-between items-center p-5 bg-blue-50/50 rounded-[28px] border border-blue-100">
                        <div class="flex gap-6">
                            <div class="text-center">
                                <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest">Distance</p>
                                <p id="stat-dist" class="text-base font-black text-gray-800">0.0 km</p>
                            </div>
                            <div class="text-center border-l border-blue-100 pl-6">
                                <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest">Est. Fare</p>
                                <p id="stat-fare" class="text-base font-black text-pya">0 Ks</p>
                            </div>
                        </div>
                        <div class="text-right">
                             <div id="active-service-tag" class="bg-pya text-white text-[9px] font-black px-3 py-1 rounded-full uppercase">OWAY</div>
                        </div>
                    </div>
                    <button onclick="confirmBooking()" id="book-confirm-btn" class="w-full bg-pya text-white py-4 rounded-[24px] font-black text-lg shadow-xl active:scale-95 transition-all">
                        အိုးဝေငှားမည်
                    </button>
                </div>

                <!-- Map Confirm Bar -->
                <div id="map-confirm-bar" class="hidden mt-6 flex gap-3">
                    <button onclick="cancelMapPick()" class="flex-1 bg-gray-100 text-gray-400 font-black py-5 rounded-[24px] text-sm">မလုပ်တော့ပါ</button>
                    <button onclick="finishMapPick()" class="flex-[2] bg-pya text-white font-black py-5 rounded-[24px] text-sm px-8 shadow-lg">တည်နေရာ အတည်ပြုမည်</button>
                </div>
            </div>
        </div>

        <!-- PROFILE / SETTINGS VIEW -->
        <div id="view-profile" class="flex-1 flex flex-col view-hidden bg-gray-50 safe-top">
             <div class="px-6 py-4 flex items-center justify-between">
                <button onclick="switchView('home')" class="p-2 bg-white rounded-xl shadow-sm"><i data-lucide="chevron-left" class="pya-blue"></i></button>
                <h1 class="text-sm font-black uppercase tracking-widest text-gray-800">Settings</h1>
                <div class="w-10"></div>
            </div>
            <div class="px-6 py-10 flex flex-col items-center">
                 <div class="w-24 h-24 bg-white rounded-[32px] p-1 shadow-xl mb-4 relative">
                    <img src="https://picsum.photos/seed/pya_profile/200" class="w-full h-full object-cover rounded-[30px]" />
                    <div class="absolute -bottom-2 -right-2 bg-green-500 border-4 border-white p-1.5 rounded-full text-white"><i data-lucide="check" class="w-3 h-3"></i></div>
                 </div>
                 <h2 class="text-xl font-black text-gray-800">ကိုအောင်</h2>
                 <p class="text-gray-400 font-bold text-xs">09 778 221 445</p>
                 <div class="w-full mt-10 space-y-4">
                    <button onclick="showToast('Profile Edit Available Soon')" class="w-full flex items-center justify-between bg-white p-5 rounded-3xl border border-gray-100 font-bold text-sm text-gray-700">
                        <div class="flex items-center gap-3"><i data-lucide="user" class="text-pya w-5 h-5"></i> Edit Profile</div>
                        <i data-lucide="chevron-right" class="text-gray-200"></i>
                    </button>
                    <button onclick="showToast('Notifications are active')" class="w-full flex items-center justify-between bg-white p-5 rounded-3xl border border-gray-100 font-bold text-sm text-gray-700">
                        <div class="flex items-center gap-3"><i data-lucide="bell" class="text-pya w-5 h-5"></i> Notifications</div>
                        <i data-lucide="chevron-right" class="text-gray-200"></i>
                    </button>
                    <button onclick="location.reload()" class="w-full bg-red-50 text-red-500 font-black py-4 rounded-3xl text-sm uppercase tracking-widest mt-8">Logout Session</button>
                 </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Navigation -->
    <div id="overlay" onclick="toggleSidebar(false)"></div>
    <div id="sidebar" class="flex flex-col">
        <div class="p-10 bg-pya text-white">
            <div class="w-20 h-20 bg-white rounded-3xl p-1 shadow-lg mb-4">
                <img src="https://picsum.photos/seed/pya_avatar/100" class="w-full h-full object-cover rounded-[22px]" />
            </div>
            <h3 class="text-2xl font-black tracking-tighter">ကိုအောင်</h3>
            <p class="text-white/70 text-xs font-bold uppercase tracking-widest">09 778 221 445</p>
        </div>
        <div class="flex-1 p-8 space-y-3">
            <button onclick="switchView('home'); toggleSidebar(false)" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-gray-50 transition-colors">
                <i data-lucide="home" class="w-5 h-5 text-gray-400"></i>
                <span class="font-bold text-gray-700">ပင်မစာမျက်နှာ</span>
            </button>
            <button onclick="switchView('profile'); toggleSidebar(false)" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-gray-50 transition-colors">
                <i data-lucide="settings" class="w-5 h-5 text-gray-400"></i>
                <span class="font-bold text-gray-700">Settings</span>
            </button>
            <button onclick="showToast('No trip history'); toggleSidebar(false)" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-gray-50 transition-colors">
                <i data-lucide="history" class="w-5 h-5 text-gray-400"></i>
                <span class="font-bold text-gray-700">Trip History</span>
            </button>
            <button onclick="window.location.href='tel:09123456789'; toggleSidebar(false)" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-gray-50 transition-colors">
                <i data-lucide="phone" class="w-5 h-5 text-gray-400"></i>
                <span class="font-bold text-gray-700">Call Support</span>
            </button>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@^2.90.1';
        const supabaseUrl = 'https://pgjeyazxdcdibtlgntcv.supabase.co';
        const supabaseKey = 'sb_publishable_htbAIYFf4liqDj1if_LEBw_B15Y0Bp9';
        const supabase = createClient(supabaseUrl, supabaseKey);

        let map, userMarker, pickupMarker, destMarker, routeLine;
        let currentPos = null, pickupPos = null, destPos = null;
        let isPicking = false, pickTarget = null, tempPos = null;
        let activeService = 'OWAY';

        window.onload = () => {
            lucide.createIcons();
            initMap();
            initAds();
            startGPS();
        };

        function initMap() {
            map = L.map('map', { zoomControl: false, center: [16.8661, 96.1951], zoom: 16 });
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            userMarker = L.marker([16.8661, 96.1951], { 
                icon: L.divIcon({ html: '<div class="user-loc-dot"></div>', className: '', iconSize:[14,14], iconAnchor:[7,7] }) 
            }).addTo(map);

            map.on('move', () => {
                if (isPicking) {
                    const center = map.getCenter();
                    tempPos = { lat: center.lat, lng: center.lng };
                    updatePinLabel(tempPos);
                }
            });
        }

        async function updatePinLabel(pos) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.lat}&lon=${pos.lng}&zoom=18`);
                const data = await res.json();
                document.getElementById('pin-label').innerText = data.display_name.split(',')[0] || "တည်နေရာရွေးပါ";
            } catch (e) {}
        }

        window.selectService = (type) => {
            activeService = type;
            const btnText = type === 'OWAY' ? 'အိုးဝေငှားမည်' : 'ကားငှားမည်';
            const iconName = type === 'OWAY' ? 'bike' : 'car';
            
            document.getElementById('book-confirm-btn').innerText = btnText;
            document.getElementById('searching-icon').setAttribute('data-lucide', iconName);
            document.getElementById('active-service-tag').innerText = type;
            lucide.createIcons();
            
            // Auto-pickup if current location exists
            if (!pickupPos && currentPos) {
                pickupPos = currentPos;
                document.getElementById('input-pickup').value = "လက်ရှိတည်နေရာ";
                addMapMarker('pickup', pickupPos);
            }
            
            switchView('map-select');
        };

        window.switchView = (view) => {
            document.getElementById('view-home').classList.add('view-hidden');
            document.getElementById('view-map-select').classList.add('view-hidden');
            document.getElementById('view-profile').classList.add('view-hidden');
            document.getElementById('view-searching').classList.add('view-hidden');
            document.getElementById(`view-${view}`).classList.remove('view-hidden');
            if (view === 'map-select') setTimeout(() => map.invalidateSize(), 200);
        };

        window.startMapPick = (target) => {
            // Auto-pickup logic: if picking destination first and pickup is empty
            if (target === 'dest' && !pickupPos && currentPos) {
                pickupPos = currentPos;
                document.getElementById('input-pickup').value = "လက်ရှိတည်နေရာ";
                addMapMarker('pickup', pickupPos);
            }

            isPicking = true;
            pickTarget = target;
            document.getElementById('center-pin').classList.remove('hidden');
            document.getElementById('location-inputs').classList.add('hidden');
            document.getElementById('map-confirm-bar').classList.remove('hidden');
            document.getElementById('route-stats').classList.add('hidden');
            
            const icon = document.getElementById('main-ping-icon');
            if (target === 'pickup') { 
                icon.classList.replace('text-red-500', 'text-green-500'); 
                icon.classList.replace('fill-red-500/20', 'fill-green-500/20'); 
            } else { 
                icon.classList.replace('text-green-500', 'text-red-500'); 
                icon.classList.replace('fill-green-500/20', 'fill-red-500/20'); 
            }

            const loc = (target === 'pickup' ? pickupPos : destPos) || currentPos || map.getCenter();
            map.flyTo([loc.lat, loc.lng], 18);
        };

        window.finishMapPick = () => {
            if (!tempPos) return;
            const addr = document.getElementById('pin-label').innerText;
            if (pickTarget === 'pickup') {
                pickupPos = tempPos;
                document.getElementById('input-pickup').value = addr;
                addMapMarker('pickup', pickupPos);
            } else {
                destPos = tempPos;
                document.getElementById('input-dest').value = addr;
                addMapMarker('dest', destPos);
            }
            lucide.createIcons();
            cancelMapPick();
            drawRoute();
        };

        function addMapMarker(type, pos) {
            if (type === 'pickup') {
                if (pickupMarker) map.removeLayer(pickupMarker);
                pickupMarker = L.marker([pos.lat, pos.lng], {
                    icon: L.divIcon({ html: '<div class="p-1 bg-green-500 rounded-full border-2 border-white shadow-lg"><i data-lucide="circle-dot" class="text-white w-4 h-4"></i></div>', className: '', iconSize:[24,24], iconAnchor:[12,12] })
                }).addTo(map);
            } else {
                if (destMarker) map.removeLayer(destMarker);
                destMarker = L.marker([pos.lat, pos.lng], {
                    icon: L.divIcon({ html: '<div class="p-1 bg-red-500 rounded-full border-2 border-white shadow-lg"><i data-lucide="map-pin" class="text-white w-4 h-4"></i></div>', className: '', iconSize:[24,24], iconAnchor:[12,12] })
                }).addTo(map);
            }
            lucide.createIcons();
        }

        window.cancelMapPick = () => {
            isPicking = false;
            document.getElementById('center-pin').classList.add('hidden');
            document.getElementById('location-inputs').classList.remove('hidden');
            document.getElementById('map-confirm-bar').classList.add('hidden');
            if (pickupPos && destPos) document.getElementById('route-stats').classList.remove('hidden');
        };

        async function drawRoute() {
            if (!pickupPos || !destPos) return;
            try {
                const res = await fetch(`https://router.project-osrm.org/route/v1/driving/${pickupPos.lng},${pickupPos.lat};${destPos.lng},${destPos.lat}?overview=full&geometries=geojson`);
                const data = await res.json();
                if (data.routes && data.routes[0]) {
                    if (routeLine) map.removeLayer(routeLine);
                    routeLine = L.geoJSON(data.routes[0].geometry, { style: { color: '#45C9FF', weight: 6, opacity: 0.9 } }).addTo(map);
                    map.fitBounds(routeLine.getBounds(), { padding: [100, 100] });
                    const dist = (data.routes[0].distance / 1000).toFixed(1);
                    const fare = (dist * (activeService === 'OWAY' ? 700 : 1200) + 1000).toFixed(0);
                    document.getElementById('route-stats').classList.remove('hidden');
                    document.getElementById('stat-dist').innerText = dist + ' km';
                    document.getElementById('stat-fare').innerText = fare + ' Ks';
                    
                    document.getElementById('searching-fare').innerText = fare + ' Ks';
                    document.getElementById('searching-dist').innerText = dist + ' km';
                }
            } catch (e) {}
        }

        window.confirmBooking = async () => {
            if (!pickupPos || !destPos) {
                showToast("တည်နေရာများ ရွေးချယ်ပါ");
                return;
            }
            switchView('searching');
            
            // Stable Supabase Integration
            const { data, error } = await supabase.from('trip_requests').insert({
                passenger_id: 'pass_mock_user_1',
                passenger_name: 'ကိုအောင်',
                pickup_lat: pickupPos.lat,
                pickup_lng: pickupPos.lng,
                drop_lat: destPos.lat,
                drop_lng: destPos.lng,
                pickup_address: document.getElementById('input-pickup').value,
                drop_address: document.getElementById('input-dest').value,
                fare: parseInt(document.getElementById('stat-fare').innerText),
                distance: parseFloat(document.getElementById('stat-dist').innerText),
                status: 'PENDING',
                vehicle_type: activeService === 'OWAY' ? 'BIKE' : 'ECONOMY',
                created_at: new Date().toISOString()
            });

            if (error) {
                console.error("Supabase Error:", error);
                showToast("ခရီးစဉ် တောင်းဆိုမှု မအောင်မြင်ပါ");
                switchView('map-select');
            }
        };

        window.cancelSearching = () => {
            switchView('map-select');
            showToast("ရှာဖွေမှု ပယ်ဖျက်လိုက်သည်");
        };

        window.handleSearch = async (val) => {
            const resBox = document.getElementById('search-results');
            if (val.length < 2) { resBox.classList.add('hidden'); return; }
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}&countrycodes=mm&limit=5`);
                const data = await res.json();
                resBox.innerHTML = '';
                resBox.classList.remove('hidden');
                data.forEach(i => {
                    const d = document.createElement('div');
                    d.className = 'p-5 hover:bg-gray-50 text-[11px] font-bold text-gray-700 cursor-pointer flex items-center gap-3';
                    d.innerHTML = `<i data-lucide="map-pin" class="w-4 h-4 text-gray-300"></i><span>${i.display_name}</span>`;
                    d.onclick = () => {
                        document.getElementById('input-dest').value = i.display_name.split(',')[0];
                        destPos = { lat: parseFloat(i.lat), lng: parseFloat(i.lon) };
                        resBox.classList.add('hidden');
                        addMapMarker('dest', destPos);
                        drawRoute();
                    };
                    resBox.appendChild(d);
                });
                lucide.createIcons();
            } catch (e) {}
        };

        function initAds() {
            let adIdx = 0;
            setInterval(() => {
                const container = document.getElementById('auto-ad-container');
                if(!container) return;
                adIdx = (adIdx + 1) % 2;
                container.style.transform = `translateX(-${adIdx * 100}%)`;
            }, 5000);
        }

        window.toggleSidebar = (open) => {
            document.getElementById('sidebar').classList.toggle('open', open);
            document.getElementById('overlay').style.display = open ? 'block' : 'none';
        };

        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        };

        async function startGPS() {
            navigator.geolocation.getCurrentPosition(p => {
                currentPos = { lat: p.coords.latitude, lng: p.coords.longitude };
                userMarker.setLatLng([currentPos.lat, currentPos.lng]);
                map.setView([currentPos.lat, currentPos.lng], 16);
            }, (err) => {
                showToast("GPS ဖွင့်ရန် လိုအပ်သည်");
            });
            navigator.geolocation.watchPosition(p => {
                currentPos = { lat: p.coords.latitude, lng: p.coords.longitude };
                userMarker.setLatLng([currentPos.lat, currentPos.lng]);
            });
        }
    </script>
</body>
</html>
