
<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Pya Pay - Passenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #45C9FF; overflow: hidden; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .pya-blue { color: #45C9FF; }
        .bg-pya { background-color: #45C9FF; }
        #map { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 0; }
        
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        
        /* High Precision User Location Marker */
        .user-loc-marker {
            width: 24px; height: 24px;
            background: #45C9FF;
            border: 4px solid white;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(69, 201, 255, 0.6);
            position: relative;
        }
        .user-loc-marker::after {
            content: '';
            position: absolute;
            width: 50px; height: 50px;
            background: rgba(69, 201, 255, 0.2);
            border-radius: 50%;
            top: -17px; left: -17px;
            animation: ripple 2s infinite;
        }
        @keyframes ripple { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }

        .service-card { border: 2px solid transparent; transition: all 0.3s; }
        .service-card.active { border-color: #45C9FF; background-color: rgba(69, 201, 255, 0.05); }
        
        /* GPS Error Overlay */
        #gps-error {
            display: none; position: fixed; inset: 0; z-index: 200;
            background: white; flex-direction: column; align-items: center; justify-content: center;
            padding: 40px; text-align: center;
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Splash Screen -->
    <div id="splash" class="fixed inset-0 z-[150] bg-pya flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="w-32 h-32 bg-white rounded-full flex items-center justify-center shadow-2xl mb-4">
            <span class="text-pya text-4xl font-black italic">PYA</span>
        </div>
        <h1 class="text-white text-4xl font-black tracking-tighter">Pya Pay</h1>
        <p class="text-white/70 font-bold uppercase tracking-[0.2em] text-[10px] mt-2 italic">Myanmar's Trusted Ride</p>
    </div>

    <!-- GPS Error Message -->
    <div id="gps-error">
        <div class="w-24 h-24 bg-red-50 rounded-full flex items-center justify-center mb-6">
            <i data-lucide="map-pin-off" class="w-12 h-12 text-red-500"></i>
        </div>
        <h2 class="text-2xl font-black text-gray-800 mb-4">GPS အချက်ပြ မရရှိပါ</h2>
        <p class="text-gray-500 font-bold mb-8 leading-relaxed">တည်နေရာ အမှန်တကယ် သိရှိနိုင်ရန် သင်၏ဖုန်းတွင် GPS တည်နေရာဖွင့်ထားရန်နှင့် App အား Permission ပေးရန် လိုအပ်ပါသည်။</p>
        <button onclick="location.reload()" class="w-full bg-pya text-white font-black py-5 rounded-[25px] text-lg shadow-2xl">ပြန်လည်ကြိုးစားမည်</button>
    </div>

    <!-- UI Components -->
    <div id="app-content" class="relative z-10 flex flex-col h-full pointer-events-none">
        <div id="map"></div>
        
        <!-- Top Nav -->
        <header class="p-6 safe-top flex items-center justify-between pointer-events-auto relative z-20">
            <button class="bg-white p-5 rounded-3xl shadow-2xl active:scale-90 transition-transform border border-gray-100">
                <i data-lucide="menu" class="pya-blue w-7 h-7"></i>
            </button>
            <div class="bg-white/90 backdrop-blur px-6 py-4 rounded-3xl shadow-2xl flex items-center gap-3 border border-gray-100">
                <div id="gps-indicator" class="w-3 h-3 rounded-full bg-gray-300"></div>
                <span class="text-xs font-black text-gray-800 tracking-tight uppercase">GPS: <span id="gps-text">Checking...</span></span>
            </div>
        </header>

        <div class="flex-1"></div>

        <!-- Recenter Button -->
        <div class="pointer-events-auto flex flex-col items-end px-6 mb-6 relative z-20">
            <button onclick="smartRecenter()" class="bg-white p-5 rounded-3xl shadow-2xl text-pya active:scale-90 transition-transform border-4 border-white">
                <i data-lucide="crosshair" class="w-8 h-8"></i>
            </button>
        </div>

        <!-- Bottom Sheet -->
        <div id="bottom-sheet" class="bg-white rounded-t-[55px] shadow-[0_-20px_80px_rgba(0,0,0,0.15)] p-10 safe-bottom animate-slide-up border-t border-gray-50 pointer-events-auto max-h-[85vh] overflow-y-auto relative z-20">
            <div class="w-20 h-1.5 bg-gray-100 rounded-full mx-auto mb-10"></div>
            
            <div id="view-home" class="space-y-8">
                <h2 class="text-3xl font-black text-gray-800 tracking-tight">ဘယ်ကို သွားမှာလဲ?</h2>
                
                <div class="space-y-4">
                    <div class="flex items-center gap-5 bg-gray-50 p-6 rounded-[30px]">
                        <div class="w-10 h-10 rounded-2xl bg-green-500 flex items-center justify-center text-white"><i data-lucide="map-pin" class="w-5 h-5"></i></div>
                        <div class="flex-1">
                            <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">My Location</p>
                            <input type="text" id="pickup-display" readonly value="တည်နေရာ ရှာဖွေနေဆဲ..." class="bg-transparent border-none outline-none w-full font-bold text-gray-800 text-lg">
                        </div>
                    </div>
                    <div class="flex items-center gap-5 bg-gray-50 p-6 rounded-[30px] border-2 border-transparent focus-within:border-pya transition-all">
                        <div class="w-10 h-10 rounded-2xl bg-red-500 flex items-center justify-center text-white"><i data-lucide="navigation" class="w-5 h-5"></i></div>
                        <div class="flex-1">
                            <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Destination</p>
                            <input type="text" id="destination-input" placeholder="သွားမည့်နေရာ ရိုက်ထည့်ပါ" class="bg-transparent border-none outline-none w-full font-bold text-gray-800 text-lg">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div onclick="setVehicle('ECONOMY')" id="v-ECONOMY" class="service-card active rounded-[30px] p-5 flex flex-col items-center gap-2 bg-gray-50/50">
                        <i data-lucide="car" class="w-7 h-7 pya-blue"></i>
                        <span class="text-[10px] font-black uppercase text-gray-800">Car</span>
                    </div>
                    <div onclick="setVehicle('BIKE')" id="v-BIKE" class="service-card rounded-[30px] p-5 flex flex-col items-center gap-2 bg-gray-50/50">
                        <i data-lucide="bike" class="w-7 h-7 text-gray-300"></i>
                        <span class="text-[10px] font-black uppercase text-gray-400">Bike</span>
                    </div>
                    <div onclick="setVehicle('VAN')" id="v-VAN" class="service-card rounded-[30px] p-5 flex flex-col items-center gap-2 bg-gray-50/50">
                        <i data-lucide="truck" class="w-7 h-7 text-gray-300"></i>
                        <span class="text-[10px] font-black uppercase text-gray-400">Van</span>
                    </div>
                </div>

                <button onclick="bookRide()" id="book-btn" class="w-full bg-pya text-white font-black py-6 rounded-[35px] shadow-2xl text-2xl active:scale-95 transition-all">
                    ကားခေါ်မည်
                </button>
            </div>

            <!-- View Searching -->
            <div id="view-searching" class="hidden py-10 text-center animate-slide-up space-y-8">
                <div class="w-32 h-32 mx-auto relative flex items-center justify-center">
                    <div class="absolute inset-0 border-8 border-pya/10 rounded-full"></div>
                    <div class="absolute inset-0 border-t-8 border-pya rounded-full animate-spin"></div>
                    <i data-lucide="search" class="w-12 h-12 text-pya"></i>
                </div>
                <h2 class="text-2xl font-black text-gray-800">ယာဉ်မောင်း ရှာဖွေနေပါသည်</h2>
                <button onclick="cancelBooking()" class="w-full bg-red-50 text-red-500 font-black py-5 rounded-[30px] text-lg">ပယ်ဖျက်မည်</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@^2.90.1';
        const supabaseUrl = 'https://pgjeyazxdcdibtlgntcv.supabase.co';
        const supabaseKey = 'sb_publishable_htbAIYFf4liqDj1if_LEBw_B15Y0Bp9';
        const supabase = createClient(supabaseUrl, supabaseKey);

        let map, userMarker, accuracyCircle;
        let currentPos = null; 
        let selectedVehicle = 'ECONOMY';
        let activeTripId = null;

        window.onload = () => {
            lucide.createIcons();
            initMap();
            startGPS();
            
            setTimeout(() => {
                document.getElementById('splash').style.opacity = '0';
                setTimeout(() => document.getElementById('splash').classList.add('hidden'), 700);
            }, 2500);
        };

        function initMap() {
            map = L.map('map', { zoomControl: false, center: [16.8661, 96.1951], zoom: 16 });
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            const userIcon = L.divIcon({
                className: 'custom-user-marker',
                html: `<div class="user-loc-marker"></div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
            userMarker = L.marker([16.8661, 96.1951], { icon: userIcon }).addTo(map);
            accuracyCircle = L.circle([16.8661, 96.1951], { radius: 0, fillOpacity: 0.1, color: '#45C9FF', stroke: false }).addTo(map);
        }

        async function startGPS() {
            const gpsIndicator = document.getElementById('gps-indicator');
            const gpsText = document.getElementById('gps-text');
            const pickupDisplay = document.getElementById('pickup-display');

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            const onSuccess = (pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                const accuracy = pos.coords.accuracy;

                currentPos = { lat, lng };
                userMarker.setLatLng([lat, lng]);
                accuracyCircle.setLatLng([lat, lng]).setRadius(accuracy);

                gpsIndicator.className = 'w-3 h-3 rounded-full bg-green-500';
                gpsText.innerText = accuracy < 30 ? 'Strong' : 'Weak';
                pickupDisplay.value = "လက်ရှိ တည်နေရာ (My Location)";

                // Initial auto-center
                if (!window.initialCentered) {
                    smartRecenter();
                    window.initialCentered = true;
                }
            };

            const onError = (err) => {
                console.error("GPS Error:", err);
                gpsIndicator.className = 'w-3 h-3 rounded-full bg-red-500';
                gpsText.innerText = 'Failed';
                if (err.code === 1 || err.code === 3) {
                    document.getElementById('gps-error').style.display = 'flex';
                }
            };

            // First attempt
            navigator.geolocation.getCurrentPosition(onSuccess, onError, options);
            // Continuous watching
            navigator.geolocation.watchPosition(onSuccess, onError, options);
        }

        window.smartRecenter = () => {
            if (currentPos) {
                map.flyTo([currentPos.lat, currentPos.lng], 18, { animate: true, duration: 1.5 });
            }
        };

        window.setVehicle = (type) => {
            selectedVehicle = type;
            document.querySelectorAll('.service-card').forEach(c => {
                c.classList.remove('active');
                c.querySelector('i').classList.replace('pya-blue', 'text-gray-300');
                c.querySelector('span').classList.replace('text-gray-800', 'text-gray-400');
            });
            const active = document.getElementById('v-' + type);
            active.classList.add('active');
            active.querySelector('i').classList.replace('text-gray-300', 'pya-blue');
            active.querySelector('span').classList.replace('text-gray-400', 'text-gray-800');
        };

        window.bookRide = async () => {
            if (!currentPos) return alert("GPS တည်နေရာ မရရှိသေးပါ။");
            const dest = document.getElementById('destination-input').value;
            if (!dest) return alert("သွားမည့်နေရာ ရိုက်ထည့်ပါ");

            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-searching').classList.remove('hidden');

            try {
                const fare = selectedVehicle === 'ECONOMY' ? 2500 : (selectedVehicle === 'BIKE' ? 1500 : 3000);
                const { data, error } = await supabase.from('trip_requests').insert([{
                    pickup_lat: currentPos.lat,
                    pickup_lng: currentPos.lng,
                    pickup_address: "Current Location",
                    drop_address: dest,
                    fare: fare,
                    distance: 3.2,
                    status: 'PENDING'
                }]).select().single();

                if (error) throw error;
                activeTripId = data.id;
                // Wait for driver logic...
            } catch (err) {
                console.error(err);
                alert("တောင်းဆိုမှု မအောင်မြင်ပါ။");
                cancelBooking();
            }
        };

        window.cancelBooking = async () => {
            if (activeTripId) await supabase.from('trip_requests').update({ status: 'CANCELLED' }).eq('id', activeTripId);
            document.getElementById('view-searching').classList.add('hidden');
            document.getElementById('view-home').classList.remove('hidden');
        };
    </script>
</body>
</html>
